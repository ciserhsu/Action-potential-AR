<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>神经动作电位 AR 交互课件</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>
    <style>
        /* 屏幕 UI 样式 */
        .ui-panel { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display:flex; gap:10px; }
        button { padding: 15px 25px; border-radius: 8px; border: none; background: #222; color: white; font-weight: bold; cursor: pointer; }
        
        /* 实时电位图容器 - 固定在屏幕左侧 */
        #chart-container { 
            position: fixed; top: 20px; left: 20px; width: 200px; height: 150px; 
            background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 10px; z-index: 100; padding: 10px;
        }
        canvas { width: 100%; height: 100%; }
        #v-text { color: #00ff00; font-family: monospace; font-size: 20px; text-align: center; }
    </style>
</head>

<body style="margin: 0px; overflow: hidden;">
    <div id="chart-container">
        <div id="v-text">-70 mV</div>
        <canvas id="apChart"></canvas>
    </div>

    <div class="ui-panel">
        <button onclick="triggerDepol()" style="background: #cc3300;">1. 去极化</button>
        <button onclick="triggerRepol()" style="background: #0066cc;">2. 复极化</button>
        <button onclick="location.reload()">重置</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-marker preset="hiro">
            <a-text value="Extracellular (Outside)" position="0 1 1" align="center" color="#FFF" scale="0.6 0.6 0.6"></a-text>
            <a-box position="0 0 0" width="3" height="0.05" depth="2" color="#F5DEB3" opacity="0.8"></a-box>
            <a-text value="Intracellular (Inside)" position="0 -0.5 1" align="center" color="#FFF" scale="0.6 0.6 0.6"></a-text>

            <a-cylinder id="na-gate" position="-0.7 0.1 0" radius="0.2" height="0.3" color="#FF4500"></a-cylinder>
            <a-cylinder id="k-gate" position="0.7 0.1 0" radius="0.2" height="0.3" color="#9370DB"></a-cylinder>

            <a-entity id="na-flow" visible="false">
                <a-sphere position="-0.7 0.8 0" radius="0.08" color="#00BFFF" 
                          animation="property: position; from: -0.7 0.8 0; to: -0.7 -0.5 0; dur: 1000; loop: true; easing: linear;"></a-sphere>
                <a-sphere position="-0.7 1.2 0" radius="0.08" color="#00BFFF" 
                          animation="property: position; from: -0.7 1.2 0; to: -0.7 -0.1 0; dur: 1000; loop: true; easing: linear;"></a-sphere>
            </a-entity>

            <a-entity id="k-flow" visible="false">
                <a-sphere position="0.7 -0.5 0" radius="0.08" color="#32CD32" 
                          animation="property: position; from: 0.7 -0.5 0; to: 0.7 0.8 0; dur: 1000; loop: true; easing: linear;"></a-sphere>
                <a-sphere position="0.7 -0.1 0" radius="0.08" color="#32CD32" 
                          animation="property: position; from: 0.7 -0.1 0; to: 0.7 1.2 0; dur: 1000; loop: true; easing: linear;"></a-sphere>
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // 绘图逻辑
        const canvas = document.getElementById('apChart');
        const ctx = canvas.getContext('2d');
        const vText = document.getElementById('v-text');
        let points = [70]; // 初始静息电位
        let currentV = -70;

        function drawChart() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, 100 - (points[0] + 80)/1.5);
            for(let i=1; i<points.length; i++) {
                ctx.lineTo(i * (canvas.width/50), 100 - (points[i] + 80)/1.5);
            }
            ctx.stroke();
            if(points.length > 50) points.shift();
        }

        function triggerDepol() {
            // AR 动画切换
            document.getElementById('na-flow').setAttribute('visible', 'true');
            document.getElementById('k-flow').setAttribute('visible', 'false');
            
            // 模拟数值变化
            let timer = setInterval(() => {
                if(currentV < 30) {
                    currentV += 5;
                    points.push(currentV);
                    vText.innerText = currentV + " mV";
                    drawChart();
                } else {
                    clearInterval(timer);
                }
            }, 50);
        }

        function triggerRepol() {
            // AR 动画切换
            document.getElementById('na-flow').setAttribute('visible', 'false');
            document.getElementById('k-flow').setAttribute('visible', 'true');

            // 模拟数值变化
            let timer = setInterval(() => {
                if(currentV > -80) {
                    currentV -= 5;
                    points.push(currentV);
                    vText.innerText = currentV + " mV";
                    drawChart();
                } else {
                    clearInterval(timer);
                }
            }, 50);
        }

        // 初始化背景
        setInterval(() => {
            if(points.length < 50) {
                points.push(currentV);
                drawChart();
            }
        }, 100);
    </script>
</body>
</html>
